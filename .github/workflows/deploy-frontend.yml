name: Deploy Frontend to Cloudflare Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm install

      - name: Generate indexes
        run: npm run generate:indexes

      - name: Prepare frontend build
        run: |
          # Use export config for Cloudflare Pages static build
          cp next.config.export.mjs next.config.mjs
          # Temporarily move dynamic routes out so they don't interfere with static export
          mkdir -p .api-backup
          mv src/app/api .api-backup/ || true
          mv src/app/search .api-backup/ || true
          mv src/app/x .api-backup/ || true
          mv src/app/admin .api-backup/ || true
          mv src/app/tweets .api-backup/ || true
          mv src/app/writing .api-backup/ || true
          mv src/app/sitemaps/tweets .api-backup/sitemaps-tweets || true

      - name: Build static export
        run: npm run build
        env:
          NEXT_PUBLIC_SITE_URL: https://elongoat.io
          NEXT_PUBLIC_API_URL: https://api.elongoat.io
          VALIDATE_ENV_ON_STARTUP: "0"
          NODE_ENV: production

      - name: Restore dynamic routes
        run: |
          mv .api-backup/api src/app/ || true
          mv .api-backup/search src/app/ || true
          mv .api-backup/x src/app/ || true
          mv .api-backup/admin src/app/ || true
          mv .api-backup/tweets src/app/ || true
          mv .api-backup/writing src/app/ || true
          mkdir -p src/app/sitemaps && mv .api-backup/sitemaps-tweets src/app/sitemaps/tweets || true
          rm -rf .api-backup || true

      - name: Deploy to Cloudflare Pages
        run: npx wrangler pages deploy out --project-name=elongoat --branch=main
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
