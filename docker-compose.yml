services:
  elongoat:
    build: .
    container_name: standalone-elongoat
    restart: unless-stopped
    # Resource limits for production stability
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1024M
        reservations:
          cpus: "0.5"
          memory: 256M
    # Memory limits (Docker Compose v2 compatibility)
    mem_limit: 1024m
    memswap_limit: 1536m
    cpus: 2.0
    environment:
      - NODE_ENV=production
      # Nginx-proxy auto-discovery for backend API
      - VIRTUAL_HOST=${API_DOMAIN:-api.elongoat.io}
      - LETSENCRYPT_HOST=${API_DOMAIN:-api.elongoat.io}
      - VIRTUAL_PORT=3000
      - NEXT_PUBLIC_SITE_URL=https://${SITE_DOMAIN:-elongoat.io}
      - NEXT_PUBLIC_API_URL=https://${API_DOMAIN:-api.elongoat.io}

      # VectorEngine (server-only)
      - VECTORENGINE_API_KEY=${VECTORENGINE_API_KEY}
      - VECTORENGINE_BASE_URL=${VECTORENGINE_BASE_URL:-https://api.vectorengine.ai}
      - VECTORENGINE_MODEL=${VECTORENGINE_MODEL:-grok-4-fast-non-reasoning}
      - VECTORENGINE_CONTENT_MODEL=${VECTORENGINE_CONTENT_MODEL:-claude-sonnet-4-5-20250929}

      # Database / cache
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}

      # Dynamic variables
      - ELON_DOB=${ELON_DOB:-1971-06-28}
      - ELON_CHILDREN_COUNT=${ELON_CHILDREN_COUNT:-14}
      - ELON_NET_WORTH=${ELON_NET_WORTH:-Varies with markets (estimate; may be outdated).}

      # Chat config
      - CHAT_MOOD=${CHAT_MOOD:-confident}
      - CHAT_TYPING_QUIRK=${CHAT_TYPING_QUIRK:-1}
      - CHAT_ANALYTICS_ENABLED=${CHAT_ANALYTICS_ENABLED:-0}

      # Admin (required for /api/admin/* - must be explicitly set)
      - ELONGOAT_ADMIN_TOKEN=${ELONGOAT_ADMIN_TOKEN}
      - ELONGOAT_ADMIN_SESSION_SECRET=${ELONGOAT_ADMIN_SESSION_SECRET}

      # RAG API (required for /api/rag/* endpoints)
      - ELONGOAT_RAG_API_KEY=${ELONGOAT_RAG_API_KEY}

      # Rate limiting security (HMAC secret for IP hashing)
      - RATE_LIMIT_IP_SECRET=${RATE_LIMIT_IP_SECRET}

      # X monitor (optional; determines primary handle displayed on /x)
      - X_HANDLES=${X_HANDLES:-elonmusk}

      # Cache warmup on startup (delay in seconds)
      - WARMUP_DELAY_MS=${WARMUP_DELAY_MS:-10}
      - SKIP_WARMUP=${SKIP_WARMUP:-0}

    volumes:
      - ./data:/app/data:ro
    # No host port binding - nginx-proxy handles external access via VIRTUAL_HOST
    expose:
      - "3000"
    networks:
      - proxy-tier
      - supabase-tier
      - redis-tier

networks:
  proxy-tier:
    external: true
    name: nginx-proxy_default
  supabase-tier:
    external: true
    name: supabase_default
  redis-tier:
    external: true
    name: redis_default
